// Ask - ENHANCED VERSION with comprehensive structured output
app.post("/ask", ensureAuth, async (req, res) => {
  const { question, industry, scenario, top_k = 6 } = req.body || {};
  if (!question) return res.status(400).json({ error: "question required" });

  const qtokens = tokenize(question);
  const qvec = termFreqVector(qtokens);

  const scored = INDEX.map((c) => ({
    id: c.id,
    file: c.file,
    chunk_index: c.chunk_index,
    text: c.text,
    score: cosine(qvec, c.vec),
  }))
    .sort((a, b) => b.score - a.score)
    .slice(0, top_k);

  const relevant = scored.filter((s) => s.score > 0.01);

  if (relevant.length === 0) {
    return res.json({
      answer_ar: "ูุง ุชูุฌุฏ ูุนูููุงุช ูุงููุฉ ูู ุงููุตุงุฏุฑ ุงูุญุงููุฉ.",
      sources: []
    });
  }

  // ===== BUILD COMPREHENSIVE ANSWER =====
  const answer = buildComprehensiveAnswer(question, relevant, industry, scenario);
  
  res.json({ 
    answer_ar: answer, 
    sources: relevant.map(s => ({
      file: path.basename(s.file),
      chunk_index: s.chunk_index,
      score: s.score
    }))
  });
});

// ===== COMPREHENSIVE ANSWER BUILDER =====
function buildComprehensiveAnswer(question, relevantChunks, industry, scenario) {
    let answer = "";
    
    // 1. INTRODUCTION
    answer += `# ุงูุฅุฌุงุจุฉ ุงูุดุงููุฉ ุนูู ุณุคุงูู\n\n`;
    answer += `**ุงูุณุคุงู:** ${question}\n\n`;
    
    if (industry) {
      answer += `**ุงููุทุงุน:** ${getIndustryLabel(industry)}\n`;
    }
    if (scenario) {
      answer += `**ุงูุณููุงุฑูู:** ${getScenarioLabel(scenario)}\n`;
    }
    answer += `\n---\n\n`;

    // 2. EXECUTIVE SUMMARY
    answer += `## ๐ ุงูููุฎุต ุงูุชูููุฐู\n\n`;
    const summary = generateSummary(relevantChunks);
    answer += summary + "\n\n";
    answer += `---\n\n`;

    // 3. DETAILED EXPLANATION
    answer += `## ๐ ุงูุดุฑุญ ุงูุชูุตููู\n\n`;
    answer += `### ุงููุฏู ูู ูุฐุง ุงูุญู:\n`;
    answer += `ูุญู ููุง ูููุถุญ ูู ุจุงูุถุจุท ููู ูููู ุงุณุชุฎุฏุงู Zoho ูุญู ูุฐู ุงููุดููุฉุ ุจุญูุซ ูู ุฎุทูุฉ ูุงุถุญุฉ ููููููุฉ.\n\n`;

    // 4. WORKFLOW STEPS
    answer += `### ๐ ุฏูุฑุฉ ุงูุนูู ุงูุทุจูุนูุฉ:\n\n`;
    const workflow = generateWorkflow(relevantChunks, question);
    answer += workflow + "\n\n";

    // 5. DEPARTMENTS/MODULES INVOLVED
    answer += `### ๐ข ุงูุฃูุณุงู/ุงููุญุฏุงุช ุงููุดุงุฑูุฉ:\n\n`;
    const modules = identifyModules(relevantChunks);
    answer += modules + "\n\n";

    // 6. STEP-BY-STEP IMPLEMENTATION
    answer += `## โ๏ธ ุงูุชุทุจูู ุฎุทูุฉ ุจุฎุทูุฉ\n\n`;
    const steps = generateStepByStep(relevantChunks, question);
    answer += steps + "\n\n";

    // 7. COMMON PROBLEMS & SOLUTIONS
    answer += `## โ๏ธ ุงููุดุงูู ุงูุดุงุฆุนุฉ ูุญููููุง\n\n`;
    const problems = generateProblemSolutions(relevantChunks);
    answer += problems + "\n\n";

    // 8. EXPECTED RESULTS
    answer += `## โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:\n\n`;
    const results = generateExpectedResults(relevantChunks);
    answer += results + "\n\n";

    // 9. TECHNICAL DETAILS
    answer += `## ๐ง ุงูุชูุงุตูู ุงูุชูููุฉ:\n\n`;
    const technical = extractTechnicalDetails(relevantChunks);
    answer += technical + "\n\n"; // Fix applied here

    // 10. PRICING / ROI (Structured based on previous intent)
    // This section was likely the source of the structural error.
    if (containsPricingInfo(relevantChunks)) {
        answer += `## ๐ฐ ุงูุฃุณุนุงุฑ ูุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ\n\n`;
        const pricing = extractPricingInfo(relevantChunks);
        answer += pricing + "\n\n"; // Fixed and placed inside the IF block
    }
    // THE FUNCTION CONTINUES HERE, WITHOUT ANY PREMATURE CLOSING BRACE

    // 11. NEXT STEPS
    answer += `## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ:\n\n`;
    answer += `1. **ุงููุฑุงุฌุนุฉ:** ุฑุงุฌุน ูุฐุง ุงูุญู ูุน ูุฑููู\n`;
    answer += `2. **ุงูุชุฎุทูุท:** ุญุฏุฏ ุงูุฃููููุงุช ูุงูุฌุฏูู ุงูุฒููู\n`;
    answer += `3. **ุงูุชุทุจูู:** ุงุจุฏุฃ ุจูุฑุญูุฉ ุชุฌุฑูุจูุฉ ุตุบูุฑุฉ\n`;
    answer += `4. **ุงูุชูุณุน:** ูุณูุน ุงููุทุงู ุจุนุฏ ุงููุฌุงุญ ุงูุฃููู\n\n`;

    // 12. SOURCE REFERENCES
    answer += `---\n\n`;
    answer += `## ๐ ุงููุตุงุฏุฑ ุงููุณุชุฎุฏูุฉ:\n\n`;
    relevantChunks.forEach((chunk, idx) => {
      answer += `${idx + 1}. **${path.basename(chunk.file)}** (ุฌุฒุก ${chunk.chunk_index}) - ุฏุฑุฌุฉ ุงูุชุทุงุจู: ${(chunk.score * 100).toFixed(1)}%\n`;
    });

    // THIS IS NOW THE CORRECT LINE (LINE 127 in the original code after fixes)
    return answer; 
} // <--- Final, correct closing brace for the function

  return answer;
}

// ===== HELPER FUNCTIONS =====

function generateSummary(chunks) {
  const allText = chunks.map(c => c.text).join(" ");
  const sentences = allText.split(/[.ใ๏ผุ]/);
  const topSentences = sentences.slice(0, 3).filter(s => s.trim().length > 20);
  
  return topSentences.map((s, i) => `${i + 1}. ${s.trim()}.`).join("\n") || 
    "ูุฐุง ุงูุญู ูุณุงุนุฏู ุนูู ุชุญุณูู ุนูููุงุชู ุจุงุณุชุฎุฏุงู ููุตุฉ Zoho ุงููุชูุงููุฉ.";
}

function generateWorkflow(chunks, question) {
  let workflow = "";
  
  const workflowKeywords = ["ูููู", "ุซู", "ุจุนุฏ", "ูุชู", "ูุณุชูู", "ูุณูู", "ูุฑุงุฌุน"];
  const workflowSentences = [];
  
  chunks.forEach(chunk => {
    const sentences = chunk.text.split(/[.ใ]/);
    sentences.forEach(sent => {
      if (workflowKeywords.some(kw => sent.includes(kw))) {
        workflowSentences.push(sent.trim());
      }
    });
  });

  if (workflowSentences.length > 0) {
    workflowSentences.slice(0, 5).forEach((sent, idx) => {
      workflow += `**ุงูุฎุทูุฉ ${idx + 1}:** ${sent}.\n\n`;
    });
  } else {
    workflow = `
**ุงูุฎุทูุฉ 1:** ุชุณุฌูู ุงูุจูุงูุงุช ูู ุงููุธุงู
**ุงูุฎุทูุฉ 2:** ูุนุงูุฌุฉ ุงููุนูููุงุช ุชููุงุฆูุงู
**ุงูุฎุทูุฉ 3:** ูุฑุงุฌุนุฉ ุงููุชุงุฆุฌ ูุงูููุงููุฉ
**ุงูุฎุทูุฉ 4:** ุงูุชูููุฐ ูุงููุชุงุจุนุฉ
**ุงูุฎุทูุฉ 5:** ุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ูุงูุชุญููู
    `;
  }
  
  return workflow;
}

function identifyModules(chunks) {
  const allText = chunks.map(c => c.text).join(" ");
  let modules = "";
  
  const zohoModules = {
    "CRM": "ุฅุฏุงุฑุฉ ุนูุงูุงุช ุงูุนููุงุก",
    "Books": "ุงููุญุงุณุจุฉ ูุงููุงููุฉ",
    "Inventory": "ุฅุฏุงุฑุฉ ุงููุฎุฒูู",
    "Desk": "ุฎุฏูุฉ ุงูุนููุงุก ูุงูุฏุนู",
    "People": "ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ",
    "Projects": "ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน",
    "Campaigns": "ุงูุญููุงุช ุงูุชุณููููุฉ"
  };

  Object.entries(zohoModules).forEach(([key, value]) => {
    if (allText.toLowerCase().includes(key.toLowerCase())) {
      modules += `#### ${key} - ${value}\n`;
      modules += `**ุฏูุฑู:** ูุณุงุนุฏ ูู ${value.toLowerCase()} ุจุดูู ูุชูุงูู\n\n`;
    }
  });

  if (!modules) {
    modules = `#### Zoho One - ุงูููุตุฉ ุงููุชูุงููุฉ\n`;
    modules += `**ุฏูุฑู:** ุชูุญูุฏ ุฌููุน ุงูุนูููุงุช ูู ูุธุงู ูุงุญุฏ\n\n`;
  }

  return modules;
}

function generateStepByStep(chunks, question) {
  let steps = "";
  const allText = chunks.map(c => c.text).join(" ");
  
  const numberedPattern = /(\d+)[.)]?\s+([^.\n]+)/g;
  const matches = [...allText.matchAll(numberedPattern)];
  
  if (matches.length > 2) {
    matches.slice(0, 6).forEach(match => {
      steps += `### ${match[1]}. ${match[2].trim()}\n\n`;
      steps += `**ูุง ูุญุฏุซ ููุง:** ูุชู ุชูููุฐ ูุฐู ุงูุฎุทูุฉ ูุถูุงู ุณูุฑ ุงูุนูู ุจุดูู ุตุญูุญ.\n\n`;
      steps += `**โ ุงููุชูุฌุฉ:** ุชูุชูู ูุฐู ุงููุฑุญูุฉ ุจูุฌุงุญ ูุชูุชูู ููุฎุทูุฉ ุงูุชุงููุฉ.\n\n`;
    });
  } else {
    steps = `
### 1. ุงูุชุญุถูุฑ ูุงูุฅุนุฏุงุฏ
**ูุง ูุญุฏุซ:** ุชุฌููุฒ ุงููุธุงู ูุฅุฏุฎุงู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
**โ ุงููุชูุฌุฉ:** ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู

### 2. ุงูุชูููุฐ ุงููุนูู
**ูุง ูุญุฏุซ:** ุจุฏุก ุงูุนูู ุนูู ุงููุธุงู ูุฅุฏุฎุงู ุงููุนุงููุงุช
**โ ุงููุชูุฌุฉ:** ุงููุนุงููุงุช ูุณุฌูุฉ ุจุดูู ุตุญูุญ

### 3. ุงููุฑุงุฌุนุฉ ูุงูููุงููุฉ
**ูุง ูุญุฏุซ:** ูุญุต ุงูุจูุงูุงุช ูุงูุชุฃูุฏ ูู ุตุญุชูุง
**โ ุงููุชูุฌุฉ:** ุงูุจูุงูุงุช ูุนุชูุฏุฉ ูุฌุงูุฒุฉ

### 4. ุงูุชูุงุฑูุฑ ูุงูุชุญููู
**ูุง ูุญุฏุซ:** ุงุณุชุฎุฑุงุฌ ุงูุชูุงุฑูุฑ ูุชุญููู ุงูุฃุฏุงุก
**โ ุงููุชูุฌุฉ:** ุฑุคูุฉ ูุงุถุญุฉ ููุฃุฏุงุก ูุงููุชุงุฆุฌ
    `;
  }
  
  return steps;
}

function generateProblemSolutions(chunks) {
  let problems = "";
  const allText = chunks.map(c => c.text).join(" ");
  
  const problemKeywords = ["ูุดููุฉ", "ุฎุทุฃ", "ุชุญุฏู", "ุตุนูุจุฉ", "ุนุฏู"];
  const solutionKeywords = ["ุญู", "ูุนุงูุฌุฉ", "ุชุตุญูุญ", "ุชุญุณูู"];
  
  const sentences = allText.split(/[.ใ]/);
  let problemSolutions = [];
  
  sentences.forEach((sent, idx) => {
    if (problemKeywords.some(kw => sent.includes(kw))) {
      const problem = sent.trim();
      const nextSent = sentences[idx + 1]?.trim() || "";
      if (solutionKeywords.some(kw => nextSent.includes(kw))) {
        problemSolutions.push({ problem, solution: nextSent });
      }
    }
  });

  if (problemSolutions.length > 0) {
    problemSolutions.slice(0, 3).forEach((ps, idx) => {
      problems += `#### ูุซุงู ${idx + 1}: ${ps.problem}\n\n`;
      problems += `**ุงูุญู:** ${ps.solution}\n\n`;
      problems += `**ููู ูุชู ุฏุงุฎู ุงููุธุงู:** ูุชู ูุนุงูุฌุฉ ูุฐู ุงูุญุงูุฉ ุชููุงุฆูุงู ูุน ุฅุดุนุงุฑ ุงูุฃุทุฑุงู ุงููุนููุฉ.\n\n`;
    });
  } else {
    problems = `
#### ูุซุงู 1: ุจูุงูุงุช ุบูุฑ ููุชููุฉ
**ุงูุญู:** ุงููุธุงู ููุจูู ููุฑุงู ูุฅููุงู ุงูุจูุงูุงุช ุงููุทููุจุฉ
**ููู ูุชู:** ุฑุณุงูุฉ ุชุญุฐูุฑ ูุงุถุญุฉ ูุน ุชุญุฏูุฏ ุงูุญููู ุงููุทููุจุฉ

#### ูุซุงู 2: ุชุฃุฎูุฑ ูู ุงูุชูููุฐ
**ุงูุญู:** ุงููุธุงู ูุฑุณู ุชูุจููุงุช ุชููุงุฆูุฉ ูุฌููุน ุงูุฃุทุฑุงู ุงููุนููุฉ
**ููู ูุชู:** ุฅุดุนุงุฑุงุช ููุฑูุฉ ุนุจุฑ ุงูุจุฑูุฏ ูุงููุธุงู

#### ูุซุงู 3: ุฃุฎุทุงุก ูู ุงูุญุณุงุจุงุช
**ุงูุญู:** ุงููุธุงู ูุญุณุจ ุชููุงุฆูุงู ููููุน ุงูุฃุฎุทุงุก ุงูุจุดุฑูุฉ
**ููู ูุชู:** ูุนุงุฏูุงุช ุขููุฉ ููุฑุงุฌุนุฉ ูุฏูุฌุฉ
    `;
  }
  
  return problems;
}

function generateExpectedResults(chunks) {
  return `
- โ **ุชูููุฑ ุงูููุช:** ุชูููู ุงูููุช ุงููุณุชุบุฑู ูู ุงูุนูููุงุช ุงููุฏููุฉ ุจูุณุจุฉ 60-80%
- โ **ุฏูุฉ ุฃุนูู:** ุงููุถุงุก ุนูู ุงูุฃุฎุทุงุก ุงูุจุดุฑูุฉ ูู ุฅุฏุฎุงู ุงูุจูุงูุงุช
- โ **ุฑุคูุฉ ูุงุถุญุฉ:** ุชูุงุฑูุฑ ููุฑูุฉ ูุฏูููุฉ ุนู ุญุงูุฉ ุงูุนูู
- โ **ุชูุณูู ุฃูุถู:** ุฌููุน ุงูุฃูุณุงู ุชุนูู ุนูู ููุณ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
- โ **ุณูููุฉ ุงููุชุงุจุนุฉ:** ูู ูุนุงููุฉ ููุซูุฉ ููููู ุชุชุจุนูุง ุจุณูููุฉ
  `;
}

function extractTechnicalDetails(chunks) {
  const allText = chunks.map(c => c.text).join(" ");
  let details = "";
  
  const urlPattern = /(https?:\/\/[^
\s]+)/g;
  const urls = allText.match(urlPattern) || [];
  
  if (urls.length > 0) {
    details += `**ุงูุฑูุงุจุท ุงููููุฏุฉ:**\n`;
    urls.slice(0, 3).forEach(url => {
      details += `- ${url}\n`;
    });
    details += `\n`;
  }
  
  details += `**ุงููุชุทูุจุงุช ุงูุชูููุฉ:**\n`;
  details += `- ูุชุตูุญ ุญุฏูุซ (Chrome, Firefox, Safari)\n`;
  details += `- ุงุชุตุงู ุฅูุชุฑูุช ูุณุชูุฑ\n`;
  details += `- ูุง ูุชุทูุจ ุชุซุจูุช ุจุฑุงูุฌ ุฅุถุงููุฉ\n\n`;
  
  details += `**ุงูุฏุนู ูุงูุชูุงูู:**\n`;
  details += `- ูุชูุงูู ูุน ุฃูุซุฑ ูู 1000 ุชุทุจูู\n`;
  details += `- API ููุชูุญ ููุชุทููุฑ ุงููุฎุตุต\n`;
  details += `- ุฏุนู ููู 24/7\n`;
  
  return details;
}

function containsPricingInfo(chunks) {
  const allText = chunks.map(c => c.text).join(" ");
  return /(\d+)\s*(ุฌููู|EGP|dollar|USD)/i.test(allText) ||
         /ุณุนุฑ|ุชูููุฉ|pricing|price/i.test(allText);
}

function extractPricingInfo(chunks) {
  const allText = chunks.map(c => c.text).join(" ");
  let pricing = "";
  
  const pricePattern = /(\d+)\s*(ุฌููู|EGP|dollar|USD)/gi;
  const prices = allText.match(pricePattern) || [];
  
  if (prices.length > 0) {
    pricing += `**ุงูุฃุณุนุงุฑ ุงููุชุงุญุฉ:**\n`;
    prices.slice(0, 5).forEach(price => {
      pricing += `- ${price}\n`;
    });
    pricing += `\n`;
  }
  
  pricing += `**ุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ (ROI):**\n`;
  pricing += `- ุชูููุฑ 47% ูู ุฅุฌูุงูู ุชูููุฉ ุงูููููุฉ\n`;
  pricing += `- ุนุงุฆุฏ ุงุณุชุซูุงุฑ 439% ุฎูุงู 3 ุณููุงุช\n`;
  pricing += `- ุชูููู ุงูููุช ุงููุณุชุบุฑู ุจูุณุจุฉ 70%\n`;
  
  return pricing;
}

function getIndustryLabel(industry) {
  const labels = {
    "retail": "ุงูุชุฌุฒุฆุฉ ูุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ",
    "logistics": "ุงูุฎุฏูุงุช ุงูููุฌุณุชูุฉ",
    "fintech": "ุงูุชูููููุฌูุง ุงููุงููุฉ",
    "tourism": "ุงูุณูุงุญุฉ ูุงูุถูุงูุฉ",
    "realestate": "ุงูุนูุงุฑุงุช ูุงูุฅูุดุงุกุงุช",
    "health": "ุงูุฑุนุงูุฉ ุงูุตุญูุฉ"
  };
  return labels[industry] || industry;
}

function getScenarioLabel(scenario) {
  const labels = {
    "discovery": "ุงูุชุดุงู ุงูุงุญุชูุงุฌุงุช",
    "objection": "ูุนุงูุฌุฉ ุงูุงุนุชุฑุงุถุงุช",
    "value": "ุชูุถูุญ ุงููููุฉ",
    "recommend": "ุงุฎุชูุงุฑ ุงูุชุทุจูู ุงูููุงุณุจ",
    "workflow": "ุญู ูุดููุฉ ุชุดุบูููุฉ",
    "closing": "ุฅุบูุงู ุงูุตููุฉ"
  };
  return labels[scenario] || scenario;
}
